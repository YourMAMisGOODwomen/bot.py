from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    ApplicationBuilder, CommandHandler,
    CallbackQueryHandler, MessageHandler,
    ContextTypes, filters
)

TOKEN = "–¢–í–û–ô_–¢–û–ö–ï–ù"
ADMIN_ID = 123456789
TON_WALLET = "–¢–í–û–ô_TON_–ö–û–®–ï–õ–Å–ö"

balances = {}
states = {}

def bal(uid):
    return round(balances.get(uid, 0), 2)

def add(uid, x):
    balances[uid] = bal(uid) + x

# ---------- START ----------
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    uid = update.effective_user.id
    balances.setdefault(uid, 0)

    kb = [
        [InlineKeyboardButton("üì• –î–µ–ø–æ–∑–∏—Ç (TON)", callback_data="deposit")],
    ]

    await update.message.reply_text(
        f"üí∞ –ë–∞–ª–∞–Ω—Å: {bal(uid)} $\n\n"
        f"üíé –î–µ–ø–æ–∑–∏—Ç TON –Ω–∞ –∫–æ—à–µ–ª—ë–∫:\n{TON_WALLET}",
        reply_markup=InlineKeyboardMarkup(kb)
    )

# ---------- CALLBACK ----------
async def callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    q = update.callback_query
    await q.answer()

    if q.data == "deposit":
        states[q.from_user.id] = "deposit_username"
        await q.message.reply_text("‚úèÔ∏è –ù–∞–ø–∏—à–∏ —Å–≤–æ–π username (@username):")

# ---------- TEXT ----------
async def text(update: Update, context: ContextTypes.DEFAULT_TYPE):
    uid = update.effective_user.id
    txt = update.message.text

    if states.get(uid) == "deposit_username":
        context.user_data["dep_user"] = txt
        states[uid] = "deposit_amount"
        await update.message.reply_text("üíé –ù–∞–ø–∏—à–∏ —Å—É–º–º—É –¥–µ–ø–æ–∑–∏—Ç–∞ –≤ TON:")
        return

    if states.get(uid) == "deposit_amount":
        try:
            ton = float(txt)
        except:
            await update.message.reply_text("‚ùå –ù–∞–ø–∏—à–∏ —á–∏—Å–ª–æ")
            return

        user = context.user_data["dep_user"]
        states.pop(uid)

        await context.bot.send_message(
            ADMIN_ID,
            f"üí∞ –ù–û–í–´–ô –î–ï–ü–û–ó–ò–¢\n"
            f"üë§ {user}\n"
            f"üíé {ton} TON\n\n"
            f"–î–ª—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è:\n"
            f"/add {user} {ton}"
        )

        await update.message.reply_text(
            "‚úÖ –ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –∞–¥–º–∏–Ω—É\n"
            "–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –±–∞–ª–∞–Ω—Å –±—É–¥–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω"
        )

# ---------- ADMIN ----------
async def add_money(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.effective_user.id != ADMIN_ID:
        return

    try:
        username = context.args[0]
        amount = float(context.args[1])
    except:
        await update.message.reply_text("‚ùå –§–æ—Ä–º–∞—Ç: /add @user 10")
        return

    for uid in balances:
        if context.bot_data.get(uid) == username:
            add(uid, amount)

    await update.message.reply_text(
        f"‚úÖ –ù–∞—á–∏—Å–ª–µ–Ω–æ {amount} $ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {username}"
    )

# ---------- SAVE USERNAMES ----------
async def save_user(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.bot_data[update.effective_user.id] = (
        "@" + update.effective_user.username
        if update.effective_user.username else "–±–µ–∑_username"
    )

# ---------- RUN ----------
def main():
    app = ApplicationBuilder().token(TOKEN).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("add", add_money))
    app.add_handler(CallbackQueryHandler(callback))
    app.add_handler(MessageHandler(filters.TEXT, text))
    app.add_handler(MessageHandler(filters.ALL, save_user))
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω")
    app.run_polling()

if __name__ == "__main__":
    main()
